<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>使用apktool实现一个apk修改和打包脚本 | kdsunset的个人博客</title><meta name="author" content="kdsunset"><meta name="copyright" content="kdsunset"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="使用apktool实现一个apk修改和打包脚本1 背景最近接到一个需求，app有多个服务器环境，上传发布时可以根据所处环境生成对应的配置参数以供app初始化时使用，我们选择的方法是在服务器对上传的apk进行解包插入配置文件并重新打包及签名，再发布。主要用到apktool及签名工具apksigner的相关知识，顺便了解一下如将java代码打包成可执行程序及脚本的使用。 2 用到的工具2.1 apkt"><meta property="og:type" content="article"><meta property="og:title" content="使用apktool实现一个apk修改和打包脚本"><meta property="og:url" content="https://kdsunset.top/u8wwtapk/index.html"><meta property="og:site_name" content="kdsunset的个人博客"><meta property="og:description" content="使用apktool实现一个apk修改和打包脚本1 背景最近接到一个需求，app有多个服务器环境，上传发布时可以根据所处环境生成对应的配置参数以供app初始化时使用，我们选择的方法是在服务器对上传的apk进行解包插入配置文件并重新打包及签名，再发布。主要用到apktool及签名工具apksigner的相关知识，顺便了解一下如将java代码打包成可执行程序及脚本的使用。 2 用到的工具2.1 apkt"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://kdsunset.top/img/avatar.jpg"><meta property="article:published_time" content="2024-08-22T08:22:00.000Z"><meta property="article:modified_time" content="2024-08-22T08:22:00.000Z"><meta property="article:author" content="kdsunset"><meta property="article:tag" content="apktool"><meta property="article:tag" content="反编译"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://kdsunset.top/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://kdsunset.top/u8wwtapk/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="oMGwvAFHPDoXj1zawKNDffRQhkEu9BwZwNxguwSOmME"><meta name="baidu-site-verification" content="codeva-AyL3HHSEEb"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?28e4ea7748d7403e4bf35f897a5e67e0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":250},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: kdsunset","link":"链接: ","source":"来源: kdsunset的个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"使用apktool实现一个apk修改和打包脚本",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-08-22 16:22:00"}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/my_bg_color.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="kdsunset的个人博客" type="application/atom+xml"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

document.addEventListener('pjax:send', () => {
  Pace.restart()
})</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js/themes/blue/pace-theme-minimal.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div><div class="menus_item"><a class="site-page" href="/donate/"><i class="fa-fw fas fa-donate"></i> <span>赞赏</span></a></div><div class="menus_item"><a class="site-page" href="/rss/"><i class="fa-fw fas fa-rss"></i> <span>RSS</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(/img/bg_moon.png)"><nav id="nav"><span id="blog-info"><a href="/" title="kdsunset的个人博客"><span class="site-name">kdsunset的个人博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div><div class="menus_item"><a class="site-page" href="/donate/"><i class="fa-fw fas fa-donate"></i> <span>赞赏</span></a></div><div class="menus_item"><a class="site-page" href="/rss/"><i class="fa-fw fas fa-rss"></i> <span>RSS</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">使用apktool实现一个apk修改和打包脚本</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-22T08:22:00.000Z" title="发表于 2024-08-22 16:22:00">2024-08-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-22T08:22:00.000Z" title="更新于 2024-08-22 16:22:00">2024-08-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="使用apktool实现一个apk修改和打包脚本"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="使用apktool实现一个apk修改和打包脚本"><a href="#使用apktool实现一个apk修改和打包脚本" class="headerlink" title="使用apktool实现一个apk修改和打包脚本"></a>使用apktool实现一个apk修改和打包脚本</h1><h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1 背景"></a>1 背景</h2><p>最近接到一个需求，app有多个服务器环境，上传发布时可以根据所处环境生成对应的配置参数以供app初始化时使用，我们选择的方法是在服务器对上传的apk进行解包插入配置文件并重新打包及签名，再发布。主要用到apktool及签名工具apksigner的相关知识，顺便了解一下如将java代码打包成可执行程序及脚本的使用。</p><h2 id="2-用到的工具"><a href="#2-用到的工具" class="headerlink" title="2 用到的工具"></a>2 用到的工具</h2><h3 id="2-1-apktool"><a href="#2-1-apktool" class="headerlink" title="2.1 apktool"></a>2.1 apktool</h3><p>Apktool 是一个开源的逆向工程工具，用于 反编译（解包）和回编译（重新打包）Android APK 文件，这里会用到其中的解包<br>和打包命令 。<br><strong>安装方式</strong></p><ol><li>从<a target="_blank" rel="noopener" href="https://apktool.org/">apktool官网</a>下载最新版的<a target="_blank" rel="noopener" href="https://bitbucket.org/iBotPeaches/apktool/downloads/">jar文件</a>，重命名为<code>apktool.jar</code></li><li>下载Apktool的启动脚本（右键保存），其作用是简化运行 Apktool 的命令行调用。不同平台的脚本不同，window上是<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/windows/apktool.bat"><code>apktool.bat</code></a>，linux则是不带后缀的<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool"><code>apktool</code></a>。</li><li>将jar文件和脚本文件保存至自定义的目录，然后将该路径添加到配置环境变量Path中，也可以复制到Path默认的目录，windows是 <code>C://Windows</code>，Linux则是 <code>/usr/local/bin</code>。</li><li>对于Linux，如果脚本文件是新建、下载或者复制建立的，还需要执行<code>chmod + x</code>命令来赋予文件可执行权限 ，之后即可使用终端来运行Apktool。</li></ol><p><strong>示例用法</strong></p><ul><li>解包 APK：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 myapp.apk 解包到 myapp_source 目录。</span></span><br><span class="line">apktool d myapp.apk -o myapp_source</span><br></pre></td></tr></table></figure></li><li>重新打包 APK</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 将 myapp_source 目录中的文件重新打包成 myapp_modified.apk。</span><br><span class="line">apktool b myapp_source -o myapp_modified.apk</span><br></pre></td></tr></table></figure><h3 id="2-2-对齐工具zipalign"><a href="#2-2-对齐工具zipalign" class="headerlink" title="2.2 对齐工具zipalign"></a>2.2 对齐工具zipalign</h3><p>对齐是一种内存优化手段，zipalign 工具会让 APK 中的资源（特别是 .so、图片、XML等）在 4 字节对齐的边界上存储，可以提高内存访问效率和节省内存。由于对齐会改变文件，破坏签名，因此应该先对齐再签名。<br><strong>命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将infile.apk 对齐，保存为 outfile.apk</span></span><br><span class="line">zipalign -P 16 -f -v 4 infile.apk outfile.apk</span><br></pre></td></tr></table></figure><p>如果APK 包含共享库（.so 个文件），请使用 -P 16 以确保它们与适合 mmap(2) 的 16KiB 页面边界对齐 在 16KiB 和 4KiB 设备中。对于其他文件，其对齐方式由 zipalign 的强制性对齐参数，应按 4 个字节对齐 在 32 位和 64 位系统上运行，注意-P是Android sdk 35 或以上新增的参数</p><h3 id="2-3-签名工具apksigner"><a href="#2-3-签名工具apksigner" class="headerlink" title="2.3 签名工具apksigner"></a>2.3 签名工具apksigner</h3><p>Android apk有专门的签名工具apksigner，apksigner会校验文件，确保 APK 完整性（防篡改），验证 APK 开发者身份。<br><strong>为 APK 签名</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 apksigner 对 APK 进行签名</span></span><br><span class="line"><span class="comment"># &lt;keystore.jks&gt;： 签名文件（.jks 格式）</span></span><br><span class="line"><span class="comment"># &lt;keyAlias&gt; ：keystore 中的 key 别名（alias）</span></span><br><span class="line"><span class="comment"># &lt;storePassword&gt;： keystore 的密码（使用 pass: 前缀表示明文）</span></span><br><span class="line"><span class="comment"># &lt;keyPassword&gt; ：私钥的密码（一般和 keystore 密码相同）</span></span><br><span class="line">apksigner sign --ks &lt;keystore.jks&gt; --ks-key-alias &lt;keyAlias&gt; --ks-pass pass:<span class="string">&quot;&lt;storePassword&gt;&quot;</span> --key-pass pass:<span class="string">&quot;&lt;keyPassword&gt;&quot;</span> --out signed_app.apk app-name.apk</span><br></pre></td></tr></table></figure><p><strong>验证 APK 签名</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确认 APK 签名是否成功</span></span><br><span class="line">apksigner verify signed.apk</span><br></pre></td></tr></table></figure><p><strong>获取签名信息</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打印证书相关信息和详细的签名</span></span><br><span class="line">apksigner verify --verbose --print-certs your_app.apk</span><br></pre></td></tr></table></figure><h3 id="2-4-在linux下安装和运行apksigner和zipalign"><a href="#2-4-在linux下安装和运行apksigner和zipalign" class="headerlink" title="2.4 在linux下安装和运行apksigner和zipalign"></a>2.4 在linux下安装和运行apksigner和zipalign</h3><p>有以下两种方式：</p><ul><li>方式一：使用官方SDK中附带的工具</li></ul><p>Android Sdk中的 build-tools文件夹，其中就包含了 apksigner 和 zipalign。</p><ol><li>下载和解压 Android SDK<br>从 Android Studio 官方网站 下载 Android Studio ，然后从菜单中下载</li><li>设置 Android SDK环境变量<br>解压下载的 SDK 包，并将 build-tools 目录添加到你的 PATH 环境变量中：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ANDROID_HOME=~/path/to/your/android-sdk</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ANDROID_HOME</span>/build-tools/&lt;version&gt;:<span class="variable">$ANDROID_HOME</span>/platform-tools</span><br></pre></td></tr></table></figure>也可以使用SDK 管理工具安装适当版本的 build-tools，<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sdkmanager <span class="string">&quot;build-tools;&lt;version&gt;</span></span><br></pre></td></tr></table></figure></li></ol><ul><li>方式二：安装 Ubuntu 包管理器的 apksigner<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装  apk 签名工具</span></span><br><span class="line">sudo apt install apksigner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 apk 对齐工具</span></span><br><span class="line">sudo apt install zipalign</span><br></pre></td></tr></table></figure></li></ul><h2 id="3-代码实现"><a href="#3-代码实现" class="headerlink" title="3 代码实现"></a>3 代码实现</h2><p>我们要实现的流程是APK 反编译（解包） → 修改 → 打包 → 签名，对于apktool命令的封装可以使用Bash、Java，Python等语言，这里使用java语言。<br><strong>1. 解包</strong><br>新建java类，解包用到apktool的d (decode) 命令。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApkProcessor</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打包apk</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sourceDir   解包后生成的目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> apkFileName 重新打包生成的 APK 文件路径，如xx.apk</span></span><br><span class="line"><span class="comment">     * created by ZHG on 2024/8/21</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">buildApk</span><span class="params">(String sourceDir, String apkFileName)</span> &#123;</span><br><span class="line">        <span class="comment">// 补上后缀</span></span><br><span class="line">        apkFileName = apkFileName.endsWith(<span class="string">&quot;.apk&quot;</span>) ? apkFileName : apkFileName + <span class="string">&quot;.apk&quot;</span>;</span><br><span class="line">        <span class="comment">// 打包命令</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> String.format(<span class="string">&quot;apktool b %s -o %s&quot;</span>, sourceDir, apkFileName);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> executeJavaCommand(command);</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">executeJavaCommand</span><span class="params">(String command)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] cmdArray = command.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdArray);</span><br><span class="line">            <span class="comment">// 如果你希望输出显示在控制台上</span></span><br><span class="line">            processBuilder.inheritIO();</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();</span><br><span class="line">            success = exitCode == <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. 修改</strong><br>使用File api将指定的文件配置文件复制到解包后的apk目录的中<code>assets</code>目录下，即app的原生资源目录下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将文件从源路径复制到目标路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> source 源文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dest   目标文件路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">copyFile</span><span class="params">(String source, String dest)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">File</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(source);</span><br><span class="line">    <span class="keyword">if</span> (!sourceFile.exists()) &#123;</span><br><span class="line">        log(<span class="string">&quot;copyFile：&quot;</span> + source + <span class="string">&quot;不存在&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log(<span class="string">&quot;复制文件：&quot;</span> + source + <span class="string">&quot; -&gt; &quot;</span> + dest);</span><br><span class="line">            Files.copy(<span class="keyword">new</span> <span class="title class_">File</span>(source).toPath(), <span class="keyword">new</span> <span class="title class_">File</span>(dest).toPath());</span><br><span class="line">            success = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>3. 打包</strong><br>这里用到的是<code>apktool</code> 的<code>b (build)</code>命令，将使用apktool解包出来的文件重新打包成apk。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 令将 myapp_source 目录中的文件重新打包成 myapp_modified.apk。</span><br><span class="line">apktool b myapp_source -o myapp_modified.apk</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打包apk</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sourceDir   解包后生成的目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> apkFileName 重新打包生成的 APK 文件路径，如xx.apk</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">buildApk</span><span class="params">(String sourceDir, String apkFileName)</span> &#123;</span><br><span class="line">    <span class="comment">// 补上后缀</span></span><br><span class="line">    apkFileName = apkFileName.endsWith(<span class="string">&quot;.apk&quot;</span>) ? apkFileName : apkFileName + <span class="string">&quot;.apk&quot;</span>;</span><br><span class="line">    <span class="comment">// 打包命令</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> String.format(<span class="string">&quot;apktool b %s -o %s&quot;</span>, sourceDir, apkFileName);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> executeJavaCommand(command);</span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4. 对齐</strong><br>这里用到了zipalign的对齐命令，-P参数需要Android sdk 35或以上。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用zipalign 对apk进行对齐优化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">zipalignApk</span><span class="params">(String apkFilePath, String outputApkFile)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">new</span> <span class="title class_">File</span>(apkFilePath).exists()) &#123;</span><br><span class="line">        log(<span class="string">&quot;zipalignApk：&quot;</span> + apkFilePath + <span class="string">&quot;文件不存在&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">signCommand</span> <span class="operator">=</span> String.format(</span><br><span class="line">            <span class="string">&quot;zipalign -P 16 -f -v 4 %s %s&quot;</span>,</span><br><span class="line">            apkFilePath, outputApkFile</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> executeJavaCommand(signCommand);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>5. 签名</strong><br>这一步用到apksigner的签名命令，如果是Windows，程序名称可能被封装成bat，因此可能需要调用对应的bat。签名密钥信息可以使用常量，也可以通过json或yaml等文件读取。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对apk进行签名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> apkFilePath   apk文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> keystoreFile  签名所使用的密钥库文件的路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> storePassword 密钥库文件的密码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> keyAlias      密钥别名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> keyPassword   密钥密码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> signedApkPath 签名后的输出文件路径</span></span><br><span class="line"><span class="comment"> * created by ZHG on 2024/8/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">signApk</span><span class="params">(</span></span><br><span class="line"><span class="params">        String apkFilePath,</span></span><br><span class="line"><span class="params">        String keystoreFile,</span></span><br><span class="line"><span class="params">        String storePassword,</span></span><br><span class="line"><span class="params">        String keyAlias,</span></span><br><span class="line"><span class="params">        String keyPassword,</span></span><br><span class="line"><span class="params">        String signedApkPath)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">new</span> <span class="title class_">File</span>(apkFilePath).exists()) &#123;</span><br><span class="line">        log(<span class="string">&quot;signApk：&quot;</span> + apkFilePath + <span class="string">&quot;文件不存在&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">new</span> <span class="title class_">File</span>(keystoreFile).exists()) &#123;</span><br><span class="line">        log(<span class="string">&quot;signApk：&quot;</span> + keystoreFile + <span class="string">&quot;文件不存在&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">osName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isWin</span> <span class="operator">=</span> (osName == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : osName).toLowerCase().contains(<span class="string">&quot;win&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">apksignerName</span> <span class="operator">=</span> isWin ? <span class="string">&quot;apksigner.bat&quot;</span> : <span class="string">&quot;apksigner&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">signCommand</span> <span class="operator">=</span> String.format(</span><br><span class="line">            apksignerName + <span class="string">&quot; sign --ks %s --ks-key-alias %s --ks-pass pass:%s --key-pass pass:%s --out %s %s&quot;</span>,</span><br><span class="line">            keystoreFile, keyAlias, storePassword, keyPassword, signedApkPath, apkFilePath</span><br><span class="line">    );</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> executeJavaCommand(signCommand);</span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取一个Android签名的配置信息，格式：</span></span><br><span class="line"><span class="comment"> * keystore:</span></span><br><span class="line"><span class="comment"> *   file: &quot;path/to/keystore&quot;</span></span><br><span class="line"><span class="comment"> *   storePassword: &quot;password&quot;</span></span><br><span class="line"><span class="comment"> *   keyAlias: &quot;alias&quot;</span></span><br><span class="line"><span class="comment"> *   keyPassword: &quot;keypassword&quot;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title function_">parseKeystoreYaml</span><span class="params">(String filePath)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">new</span> <span class="title class_">File</span>(filePath).exists())&#123;</span><br><span class="line">        log(filePath+<span class="string">&quot;签名配置文件不存在&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 读取 YAML 文件内容</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(Files.readAllBytes(Paths.get(filePath)));</span><br><span class="line">        <span class="comment">// 解析 YAML 内容（简单的实现，适用于特定格式）</span></span><br><span class="line">        Map&lt;String, String&gt; config = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        String[] lines = content.split(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String line : lines) &#123;</span><br><span class="line">            line = line.trim();</span><br><span class="line">            <span class="keyword">if</span> (line.isEmpty() || line.startsWith(<span class="string">&quot;#&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>; <span class="comment">// 跳过空行和注释</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> line.indexOf(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> line.substring(<span class="number">0</span>, index);</span><br><span class="line">                <span class="comment">// 去掉开头的空格和双引号</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> line.substring(index + <span class="number">1</span>).trim().replaceAll(<span class="string">&quot;\&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">                config.put(key.trim(), value.trim());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (config.size()&lt;<span class="number">4</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取配置信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> config.get(<span class="string">&quot;file&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">storePassword</span> <span class="operator">=</span> config.get(<span class="string">&quot;storePassword&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">keyAlias</span> <span class="operator">=</span> config.get(<span class="string">&quot;keyAlias&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">keyPassword</span> <span class="operator">=</span> config.get(<span class="string">&quot;keyPassword&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>6 修改入口方法</strong><br>我们最终的效果是在终端输入以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &lt;apkFile&gt; apk源文件路径</span></span><br><span class="line"><span class="comment"># &lt;configFile&gt; 待写入的文件</span></span><br><span class="line"><span class="comment"># &lt;outputDir&gt; 临时文件及输出目录</span></span><br><span class="line">java -jar ApkProcessor.jar &lt;apkFile&gt; &lt;configFile&gt; &lt;outputDir&gt;</span><br></pre></td></tr></table></figure><p>我们在终端输入的命令和参数对应main方法的可变长参数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApkProcessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 检查参数数量</span></span><br><span class="line">        <span class="keyword">if</span> (args.length &lt; <span class="number">4</span>) &#123;</span><br><span class="line">            log(<span class="string">&quot;缺少参数&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">apkFilePath</span> <span class="operator">=</span> args[<span class="number">1</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">targetFile</span> <span class="operator">=</span> args[<span class="number">2</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">outputDir</span> <span class="operator">=</span> args[<span class="number">3</span>];</span><br><span class="line">         <span class="comment">// 文件是否存在判断</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;sign&quot;</span>.equals(cmd))&#123;</span><br><span class="line">            zipAndSignApk(apkFilePath, targetFile, outputDir);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;full&quot;</span>.equals(cmd))&#123;</span><br><span class="line">            <span class="comment">//java ApkProcessor full &lt;apkFile&gt; &lt;configFile&gt; &lt;outputDir&gt; &lt;keystoreConfigFile&gt;</span></span><br><span class="line">            <span class="keyword">if</span> (args.length &lt; <span class="number">5</span>) &#123;</span><br><span class="line">                log(<span class="string">&quot;缺少参数&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">keystoreConfigFile</span> <span class="operator">=</span> args[<span class="number">4</span>];</span><br><span class="line">            processAllTask(apkFilePath,targetFile,outputDir,keystoreConfigFile);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">processApk</span><span class="params">(String apkFile,  String targetFile,String outputDir)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (outputDir == <span class="literal">null</span> || outputDir.length() ==<span class="number">0</span>|| outputDir.equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">apkFolder</span> <span class="operator">=</span> apkFile.substring(<span class="number">0</span>, apkFile.lastIndexOf(<span class="string">&quot;/&quot;</span>));</span><br><span class="line">            outputDir = apkFolder;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// apk解包输出目录</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">unpackDir</span> <span class="operator">=</span> outputDir + File.separator + <span class="string">&quot;unpack&quot;</span>;</span><br><span class="line">        checkDirectory(outputDir,unpackDir);</span><br><span class="line">        <span class="comment">// 配置文件复制的目标路径，即apk解包目录的资源文件夹中</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetFileName</span> <span class="operator">=</span> targetFile.substring(targetFile.lastIndexOf(File.separator) + <span class="number">1</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">configDestPath</span> <span class="operator">=</span> unpackDir + File.separator + <span class="string">&quot;assets&quot;</span> + File.separator + targetFileName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 重新打包生成的apk文件路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">apkNameWithoutSuffix</span> <span class="operator">=</span> apkFile.substring(apkFile.lastIndexOf(File.separator) + <span class="number">1</span>).replace(<span class="string">&quot;.apk&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">apkRebuildFile</span> <span class="operator">=</span> outputDir + File.separatorChar + apkNameWithoutSuffix + <span class="string">&quot;_added.apk&quot;</span>;</span><br><span class="line">        <span class="comment">// 1. 解包 APK</span></span><br><span class="line">        log(<span class="string">&quot;正在解包apk...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!decodeApk(apkFile, unpackDir)) &#123;</span><br><span class="line">            log(<span class="string">&quot;解包 APK 失败&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2. 复制配置文件</span></span><br><span class="line">        log(<span class="string">&quot;正在复制配置文件...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!copyFile(targetFile, configDestPath)) &#123;</span><br><span class="line">            log(<span class="string">&quot;复制配置文件失败&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 重新打包 APK</span></span><br><span class="line">        log(<span class="string">&quot;正在打包APK...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!buildApk(unpackDir, apkRebuildFile)) &#123;</span><br><span class="line">            log(<span class="string">&quot;打包 APK 失败&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.签名</span></span><br><span class="line">        log(<span class="string">&quot;正在签名APK...&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!signApk(apkZipalignFile, file, storePassword, keyAlias, keyPassword, signedApkFile)) &#123;</span><br><span class="line">            log(<span class="string">&quot;签名 APK 失败&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log(<span class="string">&quot;APK 处理成功，输出文件：&quot;</span> + apkRebuildFile);</span><br><span class="line">        <span class="comment">// 清理临时文件</span></span><br><span class="line">        deleteFile(<span class="keyword">new</span> <span class="title class_">File</span>(unpackDir));</span><br><span class="line">        <span class="keyword">return</span> apkRebuildFile;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="4-打包-Java-程序（JAR-文件）"><a href="#4-打包-Java-程序（JAR-文件）" class="headerlink" title="4 打包 Java 程序（JAR 文件）"></a>4 打包 Java 程序（JAR 文件）</h2><p><strong>编译</strong><br>将上述类生成字节码，执行后得到 ApkProcessor.class 文件，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -encoding UTF-8 ApkProcessor.java</span><br></pre></td></tr></table></figure><p>它也可以在终端窗口通过 <code>java &lt;类名&gt;</code> 的方式运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 程序名称后面的参数会被main方法接收</span></span><br><span class="line">java ApkProcessor &lt;args&gt;</span><br></pre></td></tr></table></figure><p><strong>创建可执行 JAR 文件</strong><br>目录结构：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ApkProcessor/</span><br><span class="line">├── ApkProcessor.class</span><br><span class="line">└── MANIFEST.MF</span><br></pre></td></tr></table></figure><p>javac 生成 .class 文件只是编译的中间产物，如果想把多个 class 和资源打包为一个能运行的 jar，只要声明 Main-Class，即可使用。要创建一个名为 ApkProcessor.jar 的 JAR 文件，步骤如下：</p><ol><li>创建一个清单文件 <code>MANIFEST.MF</code>，内容如下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Main-Class: ApkProcessor</span><br></pre></td></tr></table></figure></li><li>使用以下命令创建 JAR 文件（在 ApkProcessor.class 文件所在的目录下执行）：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar cvfm ApkProcessor.jar MANIFEST.MF ApkProcessor.class</span><br></pre></td></tr></table></figure><strong>linux下使用jar包</strong><br>在jar包所在目录（或者完整路径），使用<code>java -jar &lt;path.jar&gt; &lt;arg...&gt;</code>命令即可运行这个jar</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java -jar youjar.jar </span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"></span><br><span class="line">java -jar /path/to/youjar.jar &lt;arg...&gt;</span><br></pre></td></tr></table></figure><p><strong>将jar包使用命令封装成脚本</strong><br>进一步地，我们可以将上命令封装成脚本，再配置环境变量，就可达到跟使用其他终端命令一样的方便。</p><ul><li>Linux<br>新建<code>apkprocessor</code>文件，添加以下内容：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 使用脚本所在目录的相对路径来运行 JAR 文件</span></span><br><span class="line"><span class="comment"># 保存脚本后，确保它具有执行权限：sudo chmod +x apkprocessor</span></span><br><span class="line">java -jar <span class="string">&quot;<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)</span>/ApkProcessor.jar&quot;</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure></li><li>Windows<br>Window使用的脚本是bat，新建<code>apkprocessor.bat</code>文件，添加以下内容：<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="comment">REM 定位到ApkProcessor.jar的文件夹</span></span><br><span class="line"><span class="built_in">cd</span> &quot;E:\Download\ApkProcessor\jar&quot;</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM 参数路径</span></span><br><span class="line"><span class="built_in">set</span> INPUT_APK=&quot;E:\Download\your/apk/<span class="built_in">path</span>.apk&quot;</span><br><span class="line"><span class="built_in">set</span> CONFIG_FILE=&quot;E:\Download\your/keystore_config/<span class="built_in">path</span>.yaml&quot;</span><br><span class="line"><span class="built_in">set</span> OUTPUT_DIR=&quot;%~dp0output&quot;</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM 执行命令</span></span><br><span class="line">java -jar ApkProcessor.jar sign <span class="variable">%INPUT_APK%</span> <span class="variable">%CONFIG_FILE%</span> <span class="variable">%OUTPUT_DIR%</span> </span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure><strong>打包apk</strong><br>由于不能使用签名，因此在Android studio的终端窗口使用命令行打包apk，在Gradle终端运行以下命令:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建 release 类型的 APK（未签名）</span></span><br><span class="line">./gradlew assembleRelease</span><br></pre></td></tr></table></figure><strong>配置及使用</strong><br>最后我们在服务器上安装好java环境、对齐和签名工具，然后上传apktool和apkprocessor及对应的脚本文件，配置环境变量或直接复制到Path默认目录<code>/usr/local/bin</code>，即可使用这个脚本。</li></ul><ol><li>上传（复制）文件到自定义目录<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ApkProcessorJar/</span><br><span class="line">├──  apktool         </span><br><span class="line">├──  apktool.jar</span><br><span class="line">├──  apkprocessor</span><br><span class="line">└── ApkProcessor.jar</span><br></pre></td></tr></table></figure></li><li>添加执行权限<br>在<code>apktool</code>和<code>apkprocessor</code>脚本所在目录打开终端运行以下命令：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> +x apktool</span><br><span class="line">sudo <span class="built_in">chmod</span> +x apkprocessor</span><br></pre></td></tr></table></figure></li><li>配置环境变量<br>打开 <code>~/.bashrc</code> 文件，将<code>apktool.jar</code>和<code>ApkProcessor.jar</code>所在目录添加到环境变量，并使用<code>source ~/.bashrc</code>更新。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:path/to/ApkProcessor/jar</span><br></pre></td></tr></table></figure>即可通过命令使用这个脚本。</li></ol><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>[1]. apktool : <a target="_blank" rel="noopener" href="https://apktool.org/">https://apktool.org/</a></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://kdsunset.top">kdsunset</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://kdsunset.top/u8wwtapk/">https://kdsunset.top/u8wwtapk/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://kdsunset.top" target="_blank">kdsunset的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/apktool/">apktool</a><a class="post-meta__tags" href="/tags/%E5%8F%8D%E7%BC%96%E8%AF%91/">反编译</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/zd6207fq/" title="Ubuntu 下编译goldfish内核并使用模拟器运行"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Ubuntu 下编译goldfish内核并使用模拟器运行</div></div></a></div><div class="next-post pull-right"><a href="/lireofad/" title="Ubuntu 下编译LibreOffice Android版"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Ubuntu 下编译LibreOffice Android版</div></div></a></div></nav><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div><div class="comment-switch"><span class="first-comment">Valine</span><span id="switch-btn"></span><span class="second-comment">Gitalk</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">kdsunset</div><div class="author-info__description">kdsunset的个人博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kdsunset"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8apktool%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AAapk%E4%BF%AE%E6%94%B9%E5%92%8C%E6%89%93%E5%8C%85%E8%84%9A%E6%9C%AC"><span class="toc-text">使用apktool实现一个apk修改和打包脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%83%8C%E6%99%AF"><span class="toc-text">1 背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%94%A8%E5%88%B0%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="toc-text">2 用到的工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-apktool"><span class="toc-text">2.1 apktool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%AF%B9%E9%BD%90%E5%B7%A5%E5%85%B7zipalign"><span class="toc-text">2.2 对齐工具zipalign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E7%AD%BE%E5%90%8D%E5%B7%A5%E5%85%B7apksigner"><span class="toc-text">2.3 签名工具apksigner</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%9C%A8linux%E4%B8%8B%E5%AE%89%E8%A3%85%E5%92%8C%E8%BF%90%E8%A1%8Capksigner%E5%92%8Czipalign"><span class="toc-text">2.4 在linux下安装和运行apksigner和zipalign</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">3 代码实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%89%93%E5%8C%85-Java-%E7%A8%8B%E5%BA%8F%EF%BC%88JAR-%E6%96%87%E4%BB%B6%EF%BC%89"><span class="toc-text">4 打包 Java 程序（JAR 文件）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">参考资料</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/zd6207fq/" title="Ubuntu 下编译goldfish内核并使用模拟器运行">Ubuntu 下编译goldfish内核并使用模拟器运行</a><time datetime="2025-04-06T09:35:00.000Z" title="发表于 2025-04-06 17:35:00">2025-04-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/u8wwtapk/" title="使用apktool实现一个apk修改和打包脚本">使用apktool实现一个apk修改和打包脚本</a><time datetime="2024-08-22T08:22:00.000Z" title="发表于 2024-08-22 16:22:00">2024-08-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/lireofad/" title="Ubuntu 下编译LibreOffice Android版">Ubuntu 下编译LibreOffice Android版</a><time datetime="2024-04-15T02:35:00.000Z" title="发表于 2024-04-15 10:35:00">2024-04-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/ngiv2ray/" title="基于nginx搭建v2ray服务端配置vmess tls websocket">基于nginx搭建v2ray服务端配置vmess tls websocket</a><time datetime="2024-04-01T07:19:00.000Z" title="发表于 2024-04-01 15:19:00">2024-04-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/ubaosp13/" title="Ubuntu 下编译AOSP源码">Ubuntu 下编译AOSP源码</a><time datetime="2024-04-01T01:43:00.000Z" title="发表于 2024-04-01 09:43:00">2024-04-01</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/bg_moon.png)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By kdsunset</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '2wvhFjzp3cI1Jo1r0kGvI0PA-MdYXbMMI',
      appKey: 'jqpcAA3JdCnCM8NVPMY4nrOR',
      avatar: 'monsterid',
      serverURLs: 'https://api.kdsunset.top',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: '87bca2541154998d9e5d',
      clientSecret: 'b1b448a15758ff09af4f4810c6a66d479d01e00d',
      repo: 'kdsunset.github.io',
      owner: 'kdsunset',
      admin: ['kdsunset'],
      id: 'c4ed1985f9a3ddb977a2fed90ae2d8ba',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Valine' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script src="//github.elemecdn.com/leancloud-storage@3/dist/av-min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>